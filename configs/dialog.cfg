loadmodule "dialog.so"

modparam("dialog", "default_timeout", 21600) ## let's update to 4 hours
modparam("dialog", "early_timeout", 120)
modparam("dialog", "end_timeout", 120)
modparam("dialog", "dlg_match_mode", 1)
modparam("dialog", "send_bye", 1)
modparam("dialog", "profiles_with_value", "limiter")
modparam("dialog", "timer_procs", 1)
modparam("dialog", "enable_dmq", 0) ## pass to 0

event_route[dialog:start] {
    xlog("L_NOTICE", "A new dialog has been started - ID: $dlg(h_id) ; Call-ID: $dlg(callid)");
    route(SOURCE_ADDR_IS_EXTERNAL); ## we limit only inbound traffic to us -- provider --> GC, and not in the inverse order
    route(INCREMENT_LIMITER_PROVIDER);
}

event_route[dialog:end] {
    xlog("L_NOTICE", "Dialog ended - ID: $dlg(h_id) ; Call-ID: $dlg(callid)");
    route(DECREMENT_LIMITER_PROVIDER);
}

event_route[dialog:failed] {
    xlog("L_NOTICE", "Dialog failed - ID: $dlg(h_id) ; Call-ID: $dlg(callid)");
    route(DECREMENT_LIMITER_PROVIDER);
}

route[GET_RUNNING_NUMBER_CALLS_PROVIDER] {
    get_profile_size("limiter", "$dlg_var(set_id)", "$avp(provider_running_calls)");
    xlog("L_NOTICE", "For provider with setID: $dlg_var(set_id), currently, we have: $avp(provider_running_calls) calls running");
}

route[INCREMENT_LIMITER_PROVIDER] {
    if($dlg_var(is_from_provider) != $null) {
        set_dlg_profile("limiter", "$dlg_var(set_id)");
        route(GET_RUNNING_NUMBER_CALLS_PROVIDER);
    }
}

route[DECREMENT_LIMITER_PROVIDER] {
    if($dlg_var(is_from_provider) != $null) {
        unset_dlg_profile("limiter", "$dlg_var(set_id)");
        route(GET_RUNNING_NUMBER_CALLS_PROVIDER);
    }
}
